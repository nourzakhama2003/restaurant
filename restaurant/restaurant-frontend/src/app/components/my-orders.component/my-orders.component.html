
<div class="my-orders-container">

    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <mat-icon>history</mat-icon>
                </div>
                <div class="header-text">
                    <h1 class="page-title">Mes Commandes</h1>
                    <p class="page-subtitle">Toutes vos participations aux commandes groupées</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="back-btn" (click)="goBack()">
                    <mat-icon>arrow_back</mat-icon>
                    <span>Retour</span>
                </button>
                <button class="browse-btn" (click)="goToGroupOrders()">
                    <mat-icon>explore</mat-icon>
                    <span>Parcourir</span>
                </button>
            </div>
        </div>
    </div>

    <div class="search-filter-section">
        <div class="search-container">
            <div class="search-input-wrapper">
                <mat-icon class="search-icon">search</mat-icon>
                <input type="text" class="search-input" placeholder="Rechercher par nom de restaurant..." [(ngModel)]="searchTerm" (input)="applyFilters()" />
            </div>
        </div>

        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">
                    <mat-icon>calendar_today</mat-icon>
                    Date
                </label>
                <input type="date" class="date-input" [(ngModel)]="selectedDate" (change)="applyFilters()" />
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <mat-icon>filter_list</mat-icon>
                    Statut
                </label>
                <select class="status-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
                    <option *ngFor="let status of statusOptions" [value]="status.value">
                        {{ status.label }}
                    </option>
                </select>
            </div>

            <button class="clear-filters-btn" (click)="clearFilters()">
                <mat-icon>clear</mat-icon>
                <span>Réinitialiser</span>
            </button>
        </div>

        <div class="filter-info" *ngIf="searchTerm || selectedDate || statusFilter !== 'cree'">
            <mat-icon>filter_list</mat-icon>
            <span>{{ filteredOrders.length }} commande(s) trouvée(s) sur {{ orders.length }}</span>
        </div>
    </div>

 
    <div class="loading-container" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Chargement de vos commandes...</p>
    </div>

 
    <div class="orders-content" *ngIf="!isLoading">

        <div class="orders-grid" *ngIf="filteredOrders.length > 0">
            <div class="order-card" *ngFor="let order of filteredOrders; let i = index" [@fadeInUp] [style.animation-delay]="(i * 100) + 'ms'">
            
                <div class="card-header">
                    <div class="order-info">
                        <div class="order-icon">
                            <mat-icon>receipt_long</mat-icon>
                        </div>
                        <div class="order-details">
                            <h3 class="order-title">Commande :{{ i + 1 }}</h3>
                            <div class="participant-info">
                                <div class="participant-avatar">{{ order.participantName ? order.participantName[0] : '?' }}</div>
                                <span class="participant-name">{{ order.participantName }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="order-total">
                        <span class="total-amount">
                            {{ (order.totalAmount + (order.livraisonFeePerParticipant || 0)) | number:'1.2-2' }} TND
                        </span>
                        <span class="fee-note" style="display:block; font-size:0.95em; color:#888;">
                            inclue livraison
                        </span>
                        <span class="fee-note" *ngIf="order.livraisonFeePerParticipant" style="display:block; font-size:0.9em; color:#b77;">
                         {{ order.livraisonFeePerParticipant | number:'1.2-2' }} TND
                        </span>
                    </div>
                </div>

             
                <div class="restaurant-section" *ngIf="getRestaurantName(order.commandeId)">
                    <div class="restaurant-badge">
                        <mat-icon>restaurant</mat-icon>
                        <span>{{ getRestaurantName(order.commandeId) }}</span>
                    </div>
                </div>

    
                <div class="card-content">
                    <div class="items-section">
                        <h4 class="section-title">
                            <mat-icon>menu_book</mat-icon>
                            Plats commandés
                        </h4>
                        <div class="items-list">
                            <div class="item-card" *ngFor="let item of order.items">
                                <div class="item-info">
                                    <div class="item-name">{{ item.menuItemName }}</div>
                                    <div class="item-quantity">x{{ item.quantity }}</div>
                                </div>
                                <div class="item-price">{{ (item.unitPrice * item.quantity) | number:'1.2-2' }} TND</div>
                                <div class="item-notes" *ngIf="item.notes">
                                    <mat-icon>note</mat-icon>
                                    <span>{{ item.notes }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Notes -->
                    <div class="notes-section" *ngIf="order.notes">
                        <div class="notes-card">
                            <mat-icon class="notes-icon">sticky_note_2</mat-icon>
                            <div class="notes-content">
                                <span class="notes-label">Notes :</span>
                                <span class="notes-text">{{ order.notes }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="group-info-section" *ngIf="getCommandeInfo(order.commandeId)">
                        <h4 class="section-title">
                            <mat-icon>group_work</mat-icon>
                            Commande groupée
                        </h4>
                        <div class="group-stats">
                            <div class="stat-item">
                                <mat-icon>person</mat-icon>
                                <div class="stat-content">
                                    <span class="stat-value">{{ getCommandeInfo(order.commandeId)?.creatorName }}</span>
                                    <span class="stat-label">Créé par</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <mat-icon>attach_money</mat-icon>
                                <div class="stat-content">
                                    <span class="stat-value">{{ getCommandeInfo(order.commandeId)?.totalPrice | number:'1.2-2' }} TND</span>
                                    <span class="stat-label">Total groupe</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <mat-icon>schedule</mat-icon>
                                <div class="stat-content">
                                    <span class="stat-value">{{ formatDate(order.createdAt) }}</span>
                                    <span class="stat-label">Créé le</span>
                                </div>
                            </div>
                        </div>
                    </div>

        
                    <div class="order-meta">
                        <div class="created-date">
                            <mat-icon>schedule</mat-icon>
                            <span>{{ formatDate(order.createdAt) }}</span>
                        </div>
                        <div class="status-badge" *ngIf="getCommandeInfo(order.commandeId)">
                            <mat-icon class="status-icon">{{ getStatusIcon(getCommandeInfo(order.commandeId)?.status || '') }}</mat-icon>
                            <span>{{ getStatusLabel(getCommandeInfo(order.commandeId)?.status || '') }}</span>
                        </div>
                    </div>
                </div>

       
                <div class="card-actions">
                    <button class="action-btn view-btn" (click)="viewDetails(order.commandeId)" matTooltip="Voir les détails">
                        <mat-icon>visibility</mat-icon>
                        <span>Détails</span>
                    </button>
                    <button class="action-btn delete-btn" (click)="deleteOrder(order)" [disabled]="!canManageOrder(order)" matTooltip="Supprimer">
                        <mat-icon>delete</mat-icon>
                        <span>Supprimer</span>
                    </button>
                </div>

            
      
            </div>
        </div>

        <div class="empty-state" *ngIf="filteredOrders.length === 0">
            <div class="empty-icon">
                <mat-icon>shopping_cart_off</mat-icon>
            </div>
            <h3>Aucune commande trouvée</h3>
            <p>Vous n'avez pas encore participé à des commandes groupées ou aucun résultat ne correspond à vos filtres.</p>
            <button class="create-first-btn" (click)="goToGroupOrders()">
                <mat-icon>add_shopping_cart</mat-icon>
                <span>Parcourir les commandes</span>
            </button>
        </div>
    </div>
</div>