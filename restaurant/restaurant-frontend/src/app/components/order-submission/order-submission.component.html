<div class="order-submission-container">
    <!-- Backdrop -->


    <!-- Main Form Container -->
    <div class="order-submission-form relative z-50 rounded-md bg-white rounded-2xl shadow-2xl max-w-3xl mx-auto max-h-[80vh] flex flex-col">
        <!-- Header -->
        <div class="form-header bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 flex justify-between items-center flex-shrink-0">
            <div class="form-title-section flex items-center gap-3">
                <mat-icon class="form-icon">{{ isEditMode ? 'edit' : 'add_shopping_cart' }}</mat-icon>
                <h2>{{ isEditMode ? 'Modifier votre commande' : 'Soumettre votre commande' }}</h2>
            </div>
            <button class="close-btn" (click)="onCancel()">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <!-- Form Content -->
        <form [formGroup]="orderForm" class="order-form flex-1 flex flex-col overflow-hidden">
            <div class="form-content p-4 overflow-y-auto">
                <!-- User Info -->
                <div class="form-field">
                    <label class="field-label">
                        <mat-icon>person</mat-icon>
                        Commande au nom de *
                    </label>
                    <input class="form-input" formControlName="participantName" placeholder="Votre nom" required readonly />
                    <div class="error-message" *ngIf="orderForm.get('participantName')?.hasError('required') && orderForm.get('participantName')?.touched">
                        Le nom est requis
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="form-field">
                    <label class="field-label">
                        <mat-icon>category</mat-icon>
                        Filtrer par catégorie
                    </label>
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-select [value]="selectedCategory" (selectionChange)="onCategoryChange($event.value)">
                            <mat-option value="">Toutes les catégories</mat-option>
                            <mat-option *ngFor="let cat of availableCategories" [value]="cat">{{ cat }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Menu Items -->
                <div class="form-field">
                    <label class="field-label">
                        <mat-icon>restaurant_menu</mat-icon>
                        Sélectionner les plats
                    </label>
                    <div *ngIf="isLoadingMenuItems" class="loading-overlay">
                        <mat-spinner diameter="40"></mat-spinner>
                        <p>Chargement des plats...</p>
                    </div>
                    <div *ngIf="!isLoadingMenuItems && menuItems.length === 0" class="text-center py-8">
                        <mat-icon class="text-4xl text-gray-500">restaurant_menu</mat-icon>
                        <p class="text-gray-600">Aucun plat disponible. Contactez l'administrateur.</p>
                    </div>
                    <div formArrayName="items" *ngIf="!isLoadingMenuItems && menuItems.length > 0" class="space-y-4">
                        <div *ngFor="let item of orderItems.controls; let i = index" [formGroupName]="i" class="item-card bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-[2fr_1fr_1fr_auto] gap-4">
                                <!-- Dish Selection -->
                                <div>
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Sélectionner un plat</mat-label>
                                        <mat-select formControlName="menuItemId" (selectionChange)="onMenuItemSelect(i, $event.value)">
                                            <mat-option value="" disabled>Sélectionner un plat...</mat-option>
                                            <mat-option *ngFor="let menuItem of filteredMenuItemsByCategory" [value]="menuItem.id">
                                                <div class="flex items-center gap-2">
                                                    <img *ngIf="menuItem.imageBase64" [src]="menuItem.imageBase64" [alt]="menuItem.name" class="w-8 h-8 object-cover rounded-lg" />
                                                    <span>{{ menuItem.name }}</span>
                                                    <span class="ml-auto text-green-600">${{ menuItem.price.toFixed(2) }}</span>
                                                </div>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <div class="error-message" *ngIf="item.get('menuItemId')?.hasError('required') && item.touched">
                                        Veuillez sélectionner un plat
                                    </div>
                                </div>
                                <!-- Quantity -->
                                <div>
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Quantité</mat-label>
                                        <input matInput type="number" formControlName="quantity" min="1" (input)="calculateItemTotal(i)" />
                                    </mat-form-field>
                                    <div class="error-message" *ngIf="item.get('quantity')?.hasError('required') && item.touched">
                                        Quantité requise
                                    </div>
                                    <div class="error-message" *ngIf="item.get('quantity')?.hasError('min') && item.touched">
                                        Minimum 1
                                    </div>
                                </div>
                                <!-- Notes -->
                                <div>
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Notes</mat-label>
                                        <input matInput formControlName="notes" placeholder="ex: sans oignons" />
                                    </mat-form-field>
                                </div>
                                <!-- Actions -->
                                <div class="flex items-center">
                                    <button type="button" (click)="removeMenuItem(i)" [disabled]="orderItems.length === 1" class="remove-btn p-2 rounded-lg bg-red-50 text-red-500" title="Supprimer">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" (click)="addMenuItem()" class="add-btn flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <mat-icon>add</mat-icon>
                            Ajouter un plat
                        </button>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="form-field">
                    <label class="field-label">
                        <mat-icon>note</mat-icon>
                        Notes supplémentaires
                    </label>
                    <textarea class="form-textarea" formControlName="notes" placeholder="Instructions spéciales..."></textarea>
                </div>

                <!-- Order Summary -->
                <div class="form-field bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="field-label">
                        <mat-icon>receipt</mat-icon>
                        Résumé de la commande
                    </label>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Nombre total de plats :</span>
                            <span class="font-semibold">{{ getTotalQuantity() }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Montant total :</span>
                            <span class="font-semibold text-green-600">{{ getTotalAmount() }} TND</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions p-4 border-t border-gray-200 flex justify-between flex-shrink-0 bg-white">
                <button type="button" (click)="onCancel()" class="cancel-btn">
                    <mat-icon>close</mat-icon>
                    Annuler
                </button>
                <button type="button" (click)="onSubmit()" [disabled]="orderForm.invalid || isLoading || orderItems.length === 0" class="submit-btn">
                    <mat-icon *ngIf="!isLoading">{{ isEditMode ? 'save' : 'send' }}</mat-icon>
                    <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
                    {{ isLoading ? (isEditMode ? 'Mise à jour...' : 'Soumission...') : (isEditMode ? 'Mettre à jour' : 'Soumettre') }}
                </button>
            </div>
        </form>
    </div>
</div>