<div class="order-submission-container">
    <!-- Enhanced Backdrop with blur effect -->
    <div class="backdrop-blur-sm bg-black/30 fixed inset-0 z-40 animate-fadeIn"></div>

    <!-- Main Form Container with enhanced styling -->
    <div class="order-submission-form relative z-50 bg-white rounded-3xl shadow-2xl max-w-5xl mx-auto max-h-[95vh] overflow-hidden border border-gray-100">
        <!-- Enhanced Header with better gradient -->
        <div class="form-header bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-8 rounded-t-3xl relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-white/10 to-transparent"></div>
            <div class="relative z-10 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="header-icon bg-white/20 p-3 rounded-2xl backdrop-blur-sm border border-white/30">
                        <mat-icon class="text-white text-2xl">{{ isEditMode ? 'edit' : 'add_shopping_cart' }}</mat-icon>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold tracking-tight">{{ isEditMode ? 'Modifier votre commande' : 'Soumettre votre commande' }}</h2>
                        <p class="text-blue-100 text-base mt-2 opacity-90">Ajoutez vos articles pour rejoindre cette commande group√©e</p>
                    </div>
                </div>
                <button type="button" (click)="onCancel()" class="close-btn bg-white/20 hover:bg-white/30 p-3 rounded-2xl transition-all duration-300 backdrop-blur-sm border border-white/30 hover:scale-110">
                    <mat-icon class="text-white">close</mat-icon>
                </button>
            </div>
        </div>

        <!-- Enhanced Scrollable Content -->
        <div class="form-content p-8 overflow-y-auto max-h-[calc(95vh-140px)]">
            <form [formGroup]="orderForm" class="order-form space-y-8">
                <!-- Enhanced User Info Card -->
                <div class="user-info-card bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 p-6 rounded-2xl border border-blue-200 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center space-x-4">
                        <div class="user-avatar bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-2xl shadow-lg">
                            <mat-icon class="text-xl">person</mat-icon>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Commande au nom de</p>
                            <p class="font-bold text-gray-900 text-lg">{{ orderForm.get('participantName')?.value }}</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Category Filter -->
                <div class="category-filter-card bg-white p-6 rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300">
                    <label for="category-select" class="block text-base font-bold text-gray-800 mb-4 flex items-center">
                        <mat-icon class="mr-2 text-indigo-600">category</mat-icon>
                        Filtrer par cat√©gorie
                    </label>
                    <div class="relative">
                        <select id="category-select" class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 bg-white text-gray-800 transition-all duration-300 appearance-none font-medium" [value]="selectedCategory" (change)="onCategoryChange($any($event.target).value)">
                            <option value="">üçΩÔ∏è Toutes les cat√©gories</option>
                            <option *ngFor="let cat of availableCategories" [value]="cat">üìÇ {{ cat }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <mat-icon class="text-gray-400">expand_more</mat-icon>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Menu Items Section -->
                <div class="menu-section-card bg-gradient-to-br from-gray-50 to-white p-8 rounded-2xl border border-gray-200 shadow-sm">
                    <div class="section-header flex justify-between items-center mb-8">
                        <div class="flex items-center space-x-4">
                            <div class="section-icon bg-gradient-to-r from-green-500 to-emerald-600 p-3 rounded-2xl shadow-lg">
                                <mat-icon class="text-white text-xl">restaurant_menu</mat-icon>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900">S√©lectionner les plats</h3>
                        </div>
                        <button type="button" (click)="addMenuItem()" class="add-btn flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl hover:from-purple-600 hover:to-indigo-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 font-semibold">
                            <mat-icon>add</mat-icon>
                            <span>Ajouter un plat</span>
                        </button>
                    </div>

                    <!-- Enhanced Loading state -->
                    <div *ngIf="isLoadingMenuItems" class="loading-state text-center py-16">
                        <div class="spinner w-16 h-16 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-6"></div>
                        <p class="text-gray-600 text-lg font-medium">Chargement des plats...</p>
                    </div>

                    <!-- Enhanced No menu items available -->
                    <div *ngIf="!isLoadingMenuItems && menuItems.length === 0" class="no-menu-items text-center py-16">
                        <div class="empty-state-icon text-8xl mb-6">üçΩÔ∏è</div>
                        <h4 class="text-2xl font-bold text-gray-700 mb-3">Aucun plat disponible</h4>
                        <p class="text-gray-500 text-lg mb-8">Veuillez contacter l'administrateur du restaurant.</p>
                        <button class="add-item-btn px-8 py-4 bg-gradient-to-r from-indigo-600 to-pink-600 text-white rounded-2xl hover:from-pink-600 hover:to-indigo-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 font-semibold" type="button"
                            (click)="addItemToRestaurant()">
                            <mat-icon class="mr-3">add</mat-icon>
                            Ajouter un plat au restaurant
                        </button>
                    </div>

                    <!-- Enhanced Menu items -->
                    <div formArrayName="items" *ngIf="!isLoadingMenuItems && menuItems.length > 0" class="items-container space-y-6">
                        <div *ngFor="let item of orderItems.controls; let i = index" [formGroupName]="i" class="item-card bg-white p-8 rounded-2xl border-2 border-gray-100 hover:border-indigo-200 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2">
                            <div class="item-content grid grid-cols-1 lg:grid-cols-[2fr_1fr_2fr_1fr_auto] gap-6 items-end">
                                <!-- Enhanced Dish Selection -->
                                <div class="item-select">
                                    <label class="block text-base font-bold text-gray-800 mb-3 flex items-center">
                                        <mat-icon class="mr-2 text-indigo-600">restaurant</mat-icon>
                                        Plat
                                    </label>
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>S√©lectionner un plat...</mat-label>
                                        <mat-select formControlName="menuItemId" (selectionChange)="onMenuItemSelect(i, $event.value)">
                                            <mat-option value="" disabled>S√©lectionner un plat...</mat-option>
                                            <mat-option *ngFor="let menuItem of filteredMenuItemsByCategory" [value]="menuItem.id">
                                                <div class="flex items-center space-x-4 py-2">
                                                    <img *ngIf="menuItem.imageBase64" [src]="menuItem.imageBase64" [alt]="menuItem.name" class="w-12 h-12 object-cover rounded-xl" />
                                                    <span class="flex-1 font-medium">{{ menuItem.name }}</span>
                                                    <span class="text-green-600 font-bold text-lg">${{ menuItem.price.toFixed(2) }}</span>
                                                </div>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <div *ngIf="item.get('menuItemId')?.hasError('required') && item.touched" class="text-red-600 text-sm mt-2 flex items-center">
                                        <mat-icon class="text-sm mr-2">error</mat-icon>
                                        Veuillez s√©lectionner un plat
                                    </div>
                                </div>

                                <!-- Enhanced Quantity -->
                                <div class="item-quantity">
                                    <label class="block text-base font-bold text-gray-800 mb-3 flex items-center">
                                        <mat-icon class="mr-2 text-indigo-600">numbers</mat-icon>
                                        Quantit√©
                                    </label>
                                    <div class="quantity-input-wrapper relative">
                                        <input class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all duration-300 font-medium" type="number" formControlName="quantity" min="1" (input)="calculateItemTotal(i)" [class.border-red-500]="item.get('quantity')?.invalid && item.touched"
                                            placeholder="1">
                                    </div>
                                    <div class="text-red-600 text-sm mt-2 flex items-center" *ngIf="item.get('quantity')?.hasError('required') && item.touched">
                                        <mat-icon class="text-sm mr-2">error</mat-icon>
                                        Requis
                                    </div>
                                    <div class="text-red-600 text-sm mt-2 flex items-center" *ngIf="item.get('quantity')?.hasError('min') && item.touched">
                                        <mat-icon class="text-sm mr-2">error</mat-icon>
                                        Min 1
                                    </div>
                                </div>

                                <!-- Enhanced Notes -->
                                <div class="item-notes">
                                    <label class="block text-base font-bold text-gray-800 mb-3 flex items-center">
                                        <mat-icon class="mr-2 text-indigo-600">note</mat-icon>
                                        Notes
                                    </label>
                                    <input class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all duration-300 font-medium" formControlName="notes" placeholder="ex: sans oignons, bien cuit...">
                                </div>

                                <!-- Enhanced Subtotal -->
                                <div class="item-subtotal text-center p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border-2 border-green-200">
                                    <p class="text-sm text-green-600 mb-2 font-medium">Sous-total</p>
                                    <span class="subtotal-amount text-2xl font-bold text-green-700">${{ getItemSubtotal(i).toFixed(2) }}</span>
                                </div>

                                <!-- Enhanced Actions -->
                                <div class="item-actions self-center">
                                    <button type="button" (click)="removeMenuItem(i)" [disabled]="orderItems.length === 1" class="remove-btn p-4 rounded-2xl hover:bg-red-50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-red-100 hover:border-red-200"
                                        title="Supprimer le plat">
                                        <mat-icon class="text-red-500 text-xl">delete</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Empty state -->
                    <div *ngIf="orderItems.length === 0" class="empty-state text-center py-16">
                        <div class="empty-icon text-6xl mb-6">üõí</div>
                        <h4 class="text-2xl font-bold text-gray-700 mb-3">Aucun plat ajout√©</h4>
                        <p class="text-gray-500 text-lg mb-6">Commencez par ajouter votre premier plat</p>
                        <button type="button" (click)="addMenuItem()" class="add-first-item-btn px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl hover:from-purple-600 hover:to-indigo-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 font-semibold">
                            <mat-icon class="mr-3">add_shopping_cart</mat-icon>
                            Ajouter votre premier plat
                        </button>
                    </div>
                </div>

                <!-- Enhanced Order Notes -->
                <div class="notes-section-card bg-white p-8 rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="section-icon bg-gradient-to-r from-orange-500 to-red-600 p-3 rounded-2xl shadow-lg">
                            <mat-icon class="text-white text-xl">note</mat-icon>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">Notes suppl√©mentaires</h3>
                    </div>
                    <label class="block text-base font-bold text-gray-800 mb-3 flex items-center">
                        <mat-icon class="mr-2 text-indigo-600">edit_note</mat-icon>
                        Instructions sp√©ciales (optionnel)
                    </label>
                    <textarea class="w-full p-6 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all duration-300 resize-none font-medium" rows="4" formControlName="notes" placeholder="Instructions ou demandes sp√©ciales pour votre commande..."></textarea>
                </div>

                <!-- Enhanced Order Summary -->
                <div class="summary-section-card bg-gradient-to-br from-indigo-50 to-purple-50 p-8 rounded-2xl border-2 border-indigo-200 shadow-lg">
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="section-icon bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-2xl shadow-lg">
                            <mat-icon class="text-white text-xl">receipt</mat-icon>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">R√©sum√© de la commande</h3>
                    </div>
                    <div class="summary-content space-y-4">
                        <div class="summary-row flex justify-between items-center py-4 border-b-2 border-indigo-200">
                            <span class="text-lg font-semibold text-gray-700">Nombre total de plats :</span>
                            <span class="font-bold text-gray-900 text-xl">{{ getTotalQuantity() }}</span>
                        </div>
                        <div class="summary-row flex justify-between items-center py-4">
                            <span class="text-xl font-bold text-gray-900">Montant total :</span>
                            <span class="total-amount text-3xl font-bold text-green-600">${{ getTotalAmount() }}</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Enhanced Sticky Footer Actions -->
        <div class="form-actions bg-white border-t-2 border-gray-200 p-8 rounded-b-3xl">
            <div class="flex justify-between items-center">
                <button type="button" (click)="onCancel()" class="cancel-btn flex items-center gap-3 px-8 py-4 bg-gray-100 text-gray-700 rounded-2xl hover:bg-gray-200 transition-all duration-300 font-semibold hover:scale-105">
                    <mat-icon>close</mat-icon>
                    Annuler
                </button>
                <button type="button" (click)="onSubmit()" [disabled]="orderForm.invalid || isLoading || orderItems.length === 0" class="submit-btn flex items-center gap-3 px-10 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl hover:from-purple-600 hover:to-indigo-600 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed font-bold shadow-lg hover:shadow-xl transform hover:scale-105 disabled:transform-none">
                    <mat-icon *ngIf="!isLoading" class="text-xl">{{ isEditMode ? 'save' : 'send' }}</mat-icon>
                    <div *ngIf="isLoading" class="spinner w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
                    {{ isLoading ? (isEditMode ? 'Mise √† jour...' : 'Soumission...') : (isEditMode ? 'Mettre √† jour la commande' : 'Soumettre la commande') }}
                </button>
            </div>
        </div>
    </div>
</div>